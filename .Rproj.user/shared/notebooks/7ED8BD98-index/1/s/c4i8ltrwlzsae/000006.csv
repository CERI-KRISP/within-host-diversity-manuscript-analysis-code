"0","##import data"
"0","cmd6 <- ""ls -1 data/snpsift/*_sf.table"""
"0","snpSiftList <- system(cmd6, intern = T)"
"0","df_snps = data.frame()"
"0","for (sfreport in snpSiftList) {"
"0","  ps0 <- read_delim(sfreport, ""\t"", escape_double = FALSE, col_types = cols(.default = ""c""), trim_ws = TRUE)"
"0","  #message(""Processing: "", sfreport)"
"0","  "
"0","  fname <- sapply(str_split(sfreport, ""/"", n = 3, simplify = FALSE), `[`, 3)"
"0","  fname <- sapply(str_split(fname, ""_"", n = 2, simplify = FALSE), `[`, 1)"
"0","  "
"0","  ps0$Sample <- fname"
"0","  "
"0","  df_snps <- rbind(df_snps, ps0)"
"0","  #message(""...done!"")"
"0","}"
"0","colnames(df_snps)[c(6,9:11)] <- c(""Depth"",""Biological Effect"", ""IMPACT"", ""GENE"")"
"0","df_snps$`Biological Effect` <- gsub(""_variant"","""",df_snps$`Biological Effect`)"
"0","df_snps <- df_snps %>% separate(DP4, c(""R1+"", ""R1-"", ""R2+"", ""R2-""))"
"0","## reads supporting ref (R1) and alt(R2):"
"0","## +/- forward/reverse strand"
"0","df_snps[, c(2,5:11)] <- apply(df_snps[, c(2,5:11)], 2, as.numeric)"
"0","df_snps$R1 <- df_snps$`R1+` + df_snps$`R1-`"
"0","df_snps$R2 <- df_snps$`R2+` + df_snps$`R2-`"
"0","df_snvs_isnvs <- df_snps[,c(15,1:6,16:17,7:14)]"
"0","#df_snvs_isnvs[, c(3,6:13)] <- apply(df_snvs_isnvs[, c(3,6:13)],2,as.numeric)"
"0","df_snvs_isnvs <- df_snvs_isnvs %>% filter(!IMPACT == ""MODIFIER"" & AF >= 0.03) %>% "
"0","  mutate(`Biological Effect Cat` = case_when(`Biological Effect` == ""missense"" ~ ""non-synonymous"","
"0","                                             `Biological Effect` == ""stop_gained"" ~ ""nonsense"","
"0","                                             `Biological Effect` == ""stop_lost"" ~ ""nonsense"","
"0","                                             `Biological Effect` == ""start_lost"" ~ ""nonsense"","
"0","                                             `Biological Effect` == ""splice_region&synonymous"" ~ ""synonymous"","
"0","                                             `Biological Effect` == ""stop_lost&splice_region"" ~ ""nonsense"","
"0","                                             TRUE ~ `Biological Effect`))"
"0","##summaries - mutations, isnvs, snvs"
"0","#dim(df_snvs_isnvs) ##Number of mutations surviving - 2563"
"0","##filter out multiallelic positions"
"0","#df_snvs_isnvs %>% count(Sample,POS,REF) %>% filter(n > 1) %>% View()"
"0","df_snvs_isnvs <- df_snvs_isnvs %>% mutate(alleles = paste0(Sample,""_"",POS,""_"",REF))"
"0","dupps <- df_snvs_isnvs %>% group_by(Sample,POS,REF) %>% count() %>% filter(n > 1) %>% mutate(alleles = paste0(Sample,""_"",POS,""_"",REF))"
"0","df_snvs_isnvs_fill <- df_snvs_isnvs %>% "
"0","                          filter(!(alleles %in% dupps$alleles)) ## 2399 surviving"
"0","df_snvs_isnvs_fill$alleles <- NULL"
"0","## add protein coding region annotation"
"0","## protein length"
"0","c19_protein_locations <- read.table(file='data/C19_proteins.txt',header=FALSE,"
"0","                     sep=':',col.names=c('Protein','position'))"
"0","c19_protein_locations <- c19_protein_locations %>% "
"0","                            mutate(Protein = str_trim(Protein),"
"0","                                   position =  str_replace(position, ""\\n"", ""|"")) %>% "
"0","                                   separate(position, sep = ""\\|"", into = c(""begin"", ""end""))"
"0","rownames(c19_protein_locations) <- c19_protein_locations$Protein"
"0","df_snvs_isnvs_ann <- sqldf::sqldf(""select df_snvs_isnvs_fill.*, protein from df_snvs_isnvs_fill left join c19_protein_locations on df_snvs_isnvs_fill.POS >= begin and df_snvs_isnvs_fill.POS <= end"")"
"0","#dim(df_snvs_isnvs_ann) #4215"
"0","## keep only one entry for each allele"
"0","#df_snvs_isnvs_ann %>% count(Sample,POS,REF,ALT,AF) %>% filter(n > 1) %>% View()"
"0","df_snvs_isnvs_ann_fil <- df_snvs_isnvs_ann %>% distinct(Sample,POS,REF,ALT,AF, .keep_all = TRUE)"
"0","df_snvs_isnvs_ann_fil <- df_snvs_isnvs_ann_fil %>%  mutate(Protein = factor(Protein, levels = rownames(c19_protein_locations)),"
"0","                                                           GENE = factor(GENE, levels = c19_genes))"
"0","#dim(df_snvs_isnvs_ann_fil) #4165"
"0","#write.csv(df_snvs_isnvs, ""KPCOVID_Variants_annR.csv"", row.names = F)"
